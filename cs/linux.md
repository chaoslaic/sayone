# 简单说一下linux

linux0.11源码目录。

## 从开机加电到执行main函数之前的过程

- 启动bios，准备实模式下的中断向量表和中断服务程序
  - bios的启动原理  
    CS:IP(0xF000,0xFFF0) = 0xFFFF0
  - bios在内存中加载中断向量表和中断服务程序
    加载至0x00000
- 加载操作系统内核程序并为保护模式做准备
  - 加载第一部分内核代码---引导驱动（bootsect）  
    执行bios代码后触发0x19中断  
    0x19把第一扇区中的程序（512B）加载至0x07C00  
    bootsect对内存的规划  
    复制bootsect（0x07C00->0x90000）
  - 加载第二部分内核代码---setup  
    触发0x13中断：第二扇区开始的4个扇区加载至0x90200
  - 加载第三部分内核代码---system模块  
    触发0x13中断：第六扇区开始的约240个扇区加载至0x10000  
    再次确定根设备号  
    跳转至0x90200  
    提取内核运行所需的机器系统数据，加载至0x90000（覆盖bootsect）
- 开始向32位模式转变，为main函数的调用做准备
  - 关中断并将system移动到内存地址起始位置0x00000  
    0x10000->0x00000（覆盖bios中断向量表）
  - 设置中断描述符表和全局描述符表  
    中断描述符表：类似实模式下的中断向量表起始地址  
    全局描述符表：完成进程中各段的寻址、现场保护与现场恢复
  - 打开A20，实现32位寻址  
    从0xFFFFF扩展到0xFFFFFFFF（1MB->4GB）
  - 为保护模式下执行head.s做准备  
    setup程序对可编程中断控制器8259A进行重新编程
  - head.s开始执行  
    head程序在0x00000  
    在0x00000创建内核分页机制（页目录表、页表、缓冲区、GDT、IDT）  
    head自己废弃自己
    head的目的是将16位实模式转换为32位保护模式

head工作完成后的内存布局如下

- main... 0x064b8
- 全局描述符表（2KB） 0x05cb8
- 中断描述表（2KB） 0x054b8
- 剩余（184B） 0x05400
- 软盘缓冲区（1KB） 0x05000
- 页表3（4KB） 0x04000
- 页表2（4KB） 0x03000
- 页表1（4KB） 0x02000
- 页表0（4KB） 0x01000
- 页目录表（4KB） 0x00000

## 设备环境初始化及激活进程0

- 设置根设备、硬盘
  - 根设备：机器系统数据0x901FC
  - 硬盘：机器系统数据0x90080
- 规划物理内存格局，设置缓冲区、虚拟盘、主内存
  - 主内存区：进程代码运行的空间，包括内核管理进程的数据结构
  - 缓冲区：主机与外设进行数据交互的中转站
  - 虚拟盘区：可选，从外设上复制数据加以使用
- 设置虚拟盘空间并初始化
- 内存管理结构mem_map初始化
  - 系统通mem_map[]对1MB以上的内存分页进行管理，记录一个页面的使用次数
  - 1MB以内内核进程使用
- 异常处理类中断服务程序挂接
  - CPU以被动响应模式替代主动轮询模式处理中断信号
- 初始化块设备请求项结构
  - 块设备：硬盘、软盘。分为若干块，有块号。
  - 字符设备：键盘、命令行窗口。
  - 进程与块设备交通需通过主机内存中的缓冲区
  - 请求项管理结构request[32]是操作系统管理缓冲区中的缓冲块与块设备上逻辑块之间读写关系的数据结构
- 与建立人机交互界面相关的外设的中断服务程序挂接
  - 对串行口进行设置
  - 对显示器进行设置
  - 对键盘进行设置
- 开机启动时间设置
  - CMOS：主板上的一个小存储芯片
- 初始化进程0
  - 初始化进程0
  - 设置时钟中断
  - 设置系统调用总入口
- 初始化缓冲区管理结构
- 初始化硬盘
- 初始化软盘
- 开启中断
- 进程0由0特权级翻转到3特权级，成为真正的进程
  - 0特权级：内核特权级
  - 3特权级：用户特权级

## 进程1的创建及执行

- 进程1的创建
  - 进程0创建进程1
  - 在task[64]中为进程1申请一个空闲位置并获取进程号
  - 调用copy_process函数
  - 设置进程1的分页管理
    - 在进程1的线性地址空间中设置代码段、数据段
    - 为进程1创建第一个页表并设置对应的页目录项
  - 进程1共享进程0的文件
  - 设置进程1在GDT中的表项
  - 进程1处于就绪态
- 内核第一次做进程调度
- 轮转到进程1执行
  - 进程1为安装硬盘文件系统做准备
    - 进程1设置硬盘的hd_info
    - 读取硬盘的引导块到缓冲区
    - 将找到的缓冲块与请求项挂接
    - 读硬盘
    - 等待硬盘读数据时，进程调度切换到进程0执行
    - 进程0执行过程中发生硬盘中断
    - 读盘操作完成后，进程调度切换到进程1执行
  - 进程1格式化虚拟盘并更换根设备为虚拟盘
  - 进程1在根设备上加载根文件系统
    - 复制根设备的超级块到super_block[8]中
    - 将根设备中的根i节点挂在super_block[8]中根设备超级块上
    - 将根文件系统与进程1关联

## 进程2的创建及执行

- 打开终端设备文件及复制文件句柄
  - 打开标准输入设备文件
    - file_table[0]挂接在进程1的filp[0]
    - 确定绝对路径起点
    - 获得dev目录文件i节点
    - 确定dev目录文件i节点为枝梢i节点
    - 确定tty0文件的i节点
    - 确定tty0是字符设备文件
    - 设置file_table[0]
  - 打开标准输出、标准错误输出设备文件
- 进程1创建进程2并切换到进程2执行
- 加载shell程序
  - 关闭标准输入设备文件，打开rc文件
  - 检测shell文件
    - 检测i节点属性
    - 检测文件头属性
  - 为shell程序的执行做准备
    - 加载参数和环境变量
    - 调整进程2的管理结构
    - 为执行shell调整EIP和ESP
  - 执行shell程序
    - 执行shell引导加载第一页程序
    - 映射加载页的物理地址与线性地址
- 系统实现怠速
  - 创建update进程
  - 切换到shell进程执行
  - 重建shell

## 文件操作

- 安装文件系统
  - 获取外设的超级块
  - 确定根文件系统的挂接点
  - 将超级块与根文件系统挂接
- 打开文件
  - 将进程的*filp[20]与file_table[64]挂接
  - 获取文件i节点
  - 将文件i节点与file_table[64]挂接
- 读文件
  - 确定数据块在外设中的位置
  - 将数据库读入缓冲块
  - 将缓冲块中的数据复制到进程空间
- 新建文件
  - 查找文件
  - 新建文件i节点
  - 新建文件目录项
- 写文件
  - 确定文件的写入位置
  - 申请缓冲块
  - 将指定的数据从进程空间复制到缓冲块
  - 数据同步到外设的两种方法
- 修改文件
  - 重定位文件的当前操作指针
  - 修改文件
- 关闭文件
  - 当前进程的filp与file_table[64]脱钩
  - 文件i节点被释放
- 删除文件
  - 对文件的删除条件进行检查
  - 进行具体的删除工作

## 用户进程与内存管理

- 线性地址的保护
  - 进程线性地址空间的格局
  - 段基址、段限长、GDT、LDT、特权级
    - 从一个进程非法跨越到另一个进程
    - 从一个进程非法跨越到内核
- 分页
  - 线性地址映射到物理地址
  - 进程执行时分页
  - 进程共享页面
  - 内核分页
- 一个用户进程从创建到退出的完整过程
  - 创建str1进程
  - str1进程加载的准备工作
  - str进程的运行、加载
  - str进程的退出
- 多个用户进程同时进行
  - 进程调度
  - 页写保护
