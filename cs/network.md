# 简单说一下网络

## 计算机网络体系结构

### 五层协议

- 物理层：通过媒介传输比特，确定机械及电气规范（比特Bit）；RJ45、CLOCK、IEEE802.3（中继器，集线器）。
- 数据链路层：将比特组装成帧和点到点的传递（帧Frame）；MAC、PPP、FR、HDLC、VLAN（网桥，交换机）。
- 网络层：负责数据包从源到宿的传递和网际互连（分组、数据包Packet）；IP、ICMP、ARP、RARP、OSPF、IPX、RIP、IGRP（路由器）。
- 传输层：提供端到端的可靠报文传递和错误恢复（数据段Segment）；TCP、UDP、SPX。
  - TCP：传输控制协议，提供面向连接、可靠、字节流的数据传输完整性服务，数据单位为报文段。
  - UDP：用户数据报协议，提供无连接、尽最大努力、报文的数据传输及时性服务，数据单位为用户数据报。
- 应用层：允许访问OSI环境的手段（应用协议数据单元APDU）；FTP、DNS、Telnet、SMTP、HTTP、WWW、NFS。

### OSI七层模型

Open System Interconnect，开放式系统互联，把网络协议分为七层。上述五层协议中没有表示层和会话层，而是将这些功能留给应用程序开发者处理。

- 会话层：建立、管理和终止会话；数据单元是SPDU；协议有NFS、SQL、NETBIOS、RPC。
- 表示层：对数据进行翻译、加密和压缩；数据单元是PPDU；协议有JPEG、MPEG、ASII。

### TCP/IP四层模型

它只有四层，相当于五层协议中物理层和数据链路层合并为网络接口层。

TCP/IP体系结构不严格遵循OSI分层概念，应用层可能会直接使用IP层或者网络接口层。

## 物理层

### 通道

- 单工通信：单向传输。
- 半双工通信：双向交替传输。
- 全双工通信：双向同时传输。

### 通道复用技术

- 频分复用（FDM，Frequency Division Multiplexing）：不同用户在不同频带，所有用户在同样时间占用不同带宽资源。
- 时分复用（TDM，Time Division Multiplexing）：不同用户在同一时间段的不同时间片，所有用户在不同时间占用同样的频带宽度。
- 波分复用（WDM，Wavelength Division Multiplexing）：光的频分复用。
- 码分复用（CDM，Code Division Multiplexing）：不同用户使用不同的码，可以在同样时间使用同样频带通信。

### 带通调制

模拟信号是连续的信号，数字信号是离散的信号。带通调制把数字信号转换为模拟信号。

## 数据链路层

### 三个基本问题

- 封装成帧：把网络层的IP数据报封装成帧，SOH - 数据部分 - EOT。
- 透明传输：不管数据部分是什么字符，都能传输出去；可以通过字节填充方法解决（冲突字符前加转义字符）。
- 差错检测：降低误码率（BER，Bit Error Rate），广泛使用循环冗余检测（CRC，Cyclic Redundancy Check）。

### 信道

- 点对点信道：一对一通信。不会冲突，使用PPP协议进行控制。
  - 点对点协议（Point-to-Point Protocol）：用户计算机和ISP通信时所使用的协议。
- 广播信道：一对多通信。所有节点在同一广播信道上发送数据，为避免冲突使用通道复用技术、CSMA/CD协议进行协调。
  - 单播（unicast）帧（一对一）：收到帧的MAC地址与本站的硬件地址相同。
  - 广播（broadcast）帧（一对全体）：发送给本局域网上所有站点的帧。
  - 多播（multicast）帧（一对多）：发送给本局域网上一部分站点的帧。

## 网络层

### 网络层协议

- IP（Internet Protocol，网际协议）：是为计算机网络相互连接进行通信而设计的协议。
- ARP（Address Resolution Protocol，地址解析协议）：负责将局域网中的IP地址转换为网卡的MAC地址。
- NAT（Network Address Translation，网络地址转换）：局域网内使用内网地址，当内部节点要与外部网络进行通讯时，在网关处将内部地址替换成公网地址。
- ICMP（Internet Control Message Protocol，网际控制报文协议）：为了更有效地转发IP数据报和提高交付成功的机会。它封装在IP数据报中，但是不属于高层协议。
- IGMP（Internet Group Management Protocol，网际组管理协议）：管理组成员关系的协议。

### ip

ip报文格式。

- 版本：有4（IPv4）和6（IPv6）两个值。
- 首部长度：占4位，因此最大值为15。值为1表示的是1个32位字的长度，也就是4字节。因为固定部分长度为20字节，因此该值最小为5。如果可选字段的长度不是4字节的整数倍，就用尾部的填充部分来填充。
- 区分服务：用来获得更好的服务，一般情况下不使用。
- 总长度：包括首部长度和数据部分长度。
- 生存时间：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当TTL为0时就丢弃数据报
- 协议：指出携带的数据应该上交给哪个协议进行处理，例如ICMP、TCP、UDP等。
- 首部检验和：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
- 标识：在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
- 片偏移：和标识符一起，用于发生分片的情况。片偏移的单位为8字节。

## 传输层

### udp

用户数据报协议（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用层传下来的报文不合并也不拆分，只是添加UDP首部），支持一对一、一对多、多对一和多对多的交互通信。

首部字段只有8个字节，包括源端口、目的端口、长度、检验和。12字节的伪首部是为了计算检验和临时添加的。

### tcp

传输控制协议（Transmission Control Protocol）是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文按字节流组织成大小不等的数据块），每一条TCP连接只能是点对点的。

- 序号：用于对字节流进行编号，例如序号为301，表示第一个字节的编号为301，如果携带的数据长度为100字节，那么下一个报文段的序号应为401。
- 确认号：期望收到的下一个报文段的序号。例如B正确收到A发送来的一个报文段，序号为501，携带的数据长度为200字节，因此B 期望下一个报文段的序号为701，B发送给A的确认报文段中确认号就为701。
- 数据偏移：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。
- 确认ACK：当ACK=1时确认号字段有效，否则无效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置1。
- 同步SYN：在连接建立时用来同步序号。当SYN=1，ACK=0时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中SYN=1，ACK=1。
- 终止FIN：用来释放一个连接，当FIN=1时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
- 窗口：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

#### 三次握手

- 客户端发送SYN包（seq=i），状态为SYN_SENT。
- 服务端收到SYN包，发送ACK包（ack=i+1）、SYN包（seq=j），状态从LISTEN到SYN_RECV。
- 客户端收到SYN、ACK包，发送ACK包（ack=j+1），发送完毕后客户端和服务端的状态为ESTABLISHED。

不是两次握手的原因：防止已失效的连接请求报文段又传到了服务端。其次，两次握手无法保证客户端正确接收第二次握手的报文（服务端无法确认客户端是否收到），也无法保证客户端和服务端之间成功互换初始序列号。

客户端发送ACK包丢失：服务端会重新发SYN、ACK包；客户端认为连接建立，写数据时，会触发RST包，可以感知到服务端的错误。

#### 四次挥手

- 客户端发送FIN包（seq=k），状态为FIN_WAIT_1。
- 服务端收到FIN包，发送ACK包（ack=k+1），状态为CLOSE_WAIT。
  - 客户端收到ACK包，状态为FIN_WAIT_2。
- 服务端发送FIN包（seq=l），状态为LAST_ACK。
- 客户端收到FIN包，发送ACK包（ack=l+1），状态为TIME_WAIT，等待2*MSL后状态为CLOSED。
  - 服务端收到ACK包，状态为CLOSED。

不是三次挥手的原因：服务端收到客户端断开连接的请求时，可能还有一些数据没有发完，这时先回复ACK，表示接收到了断开连接的请求。等到数据发完之后再发FIN，断开服务端到客户端的数据传送。

第四次挥手时，客户端发送给服务端的ACK有可能丢失，TIME_WAIT状态就是用来重发可能丢失的ACK报文。如果服务端没有收到ACK，就会重发FIN，如果客户端在2*MSL的时间内收到了FIN，就会重新发送ACK并再次等待2MSL，防止服务端没有收到ACK而不断重发FIN。

MSL（Maximum Segment Lifetime，报文段最长寿命），指一个片段在网络中最大的存活时间，2MSL就是一个发送和一个回复所需的最大时间。如果直到2MSL，客户端都没有再次收到FIN，那么客户端推断ACK已经被成功接收，则结束TCP连接。

#### 滑动窗口

窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，接收方通过TCP报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。

发送窗口内的字节都允许被发送，接收窗口内的字节都允许被接收。如果发送窗口左部的字节已经发送并且收到了确认，那么就将发送窗口向右滑动一定距离，直到左部第一个字节不是已发送并且已确认的状态；接收窗口的滑动类似，接收窗口左部字节已经发送确认并交付主机，就向右滑动接收窗口。

接收窗口只会对窗口内最后一个按序到达的字节进行确认，例如接收窗口已经收到的字节为{31, 34, 35}，其中{31}按序到达，而{34, 35}就不是，因此只对字节31进行确认。发送方得到一个字节的确认之后，就知道这个字节之前的所有字节都已经被接收。

#### 流量控制

流量控制是为了控制发送方发送速率，保证接收方来得及接收。

接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为0，则发送方不能发送数据。

#### 拥塞控制

如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。因此当出现拥塞时，应当控制发送方的速率。这一点和流量控制很像，但是出发点不同。流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。

TCP主要通过四个算法来进行拥塞控制：慢开始、拥塞避免、快重传、快恢复。

发送方需要维护一个叫做拥塞窗口（cwnd）的状态变量，注意拥塞窗口与发送方窗口的区别：拥塞窗口只是一个状态变量，实际决定发送方能发送多少数据的是发送方窗口。

##### 慢开始与拥塞避免

发送的最初执行慢开始，令cwnd = 1，发送方只能发送1个报文段；当收到确认后，将cwnd加倍，因此之后发送方能够发送的报文段数量为：2、4、8...

注意到慢开始每个轮次都将cwnd加倍，这样会让cwnd增长速度非常快，从而使得发送方发送的速度增长速度过快，网络拥塞的可能性也就更高。设置一个慢开始门限ssthresh，当cwnd >= ssthresh时，进入拥塞避免，每个轮次只将cwnd加1。

如果出现了超时，则令ssthresh = cwnd / 2，然后重新执行慢开始。

##### 快重传与快恢复

在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。例如已经接收到 M1 和 M2，此时收到 M4，应当发送对 M2 的确认。

在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。例如收到三个 M2，则 M3 丢失，立即重传 M3。

在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免。

慢开始和快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh。

## 应用层

常用端口

应用 | 应用层协议 | 端口号 | 传输层协议
-|-|-|-
域名解析 | DNS | 53 | UDP/TCP
动态主机配置协议 | DHCP | 67/68 | UDP
简单网络管理协议 | SNMP | 161/162 | UDP
文件传送协议 | FTP | 20/21 | TCP
远程终端协议 | TELNET | 23 | TCP
超文本传送协议 | HTTP | 80 | TCP
简单邮件传送协议 | SMTP | 25 | TCP
邮件读取协议 | POP3 | 110 | TCP
网际报文存取协议 | IMAP | 143 | TCP

### tls

- 客户端向服务器发送请求，同时发送客户端支持的一套加密规则（包括对称加密、非对称加密、摘要算法）。
- 服务器从中选出一组加密算法与摘要算法，向客户端发送证书链。
- 客户端验证服务器的合法性后：
  - 生成对称加密的密钥，用服务器公钥对密钥加密（非对称算法）。
  - 对握手消息进行摘要计算（摘要算法），对摘要值进行密钥加密（对称算法）。
  - 将加密后的随机密钥和摘要一起发送给服务器。
  - 服务器接收数据后使用自己的私钥解密，得到对称加密的密钥。
  - 用这个密钥解密出摘要值，并验证握手消息是否一致。
- 服务器对握手消息进行摘要计算（摘要算法），对摘要值进行密钥加密（对称算法）发给客户端。
  - 客户端解密并验证摘要，若一致，则握手结束。

非对称加密算法用于在握手过程中加密生成的密码；对称加密算法用于对真正传输的数据进行加密；摘要算法用于验证数据的完整性。

### http

- http1.0：默认是短连接，每次与服务器交互，都需要新开一个连接。
- http1.1：默认是持久化连接，建立一次连接，多次请求均由这个连接完成。
- http2：二进制分帧（不再以文本格式传输）、多路复用。

### https

- TCP协议需要通过三次握手建立TCP连接保证通信的可靠性（1.5-RTT）。
- TLS协议会在TCP协议之上通过四次握手建立TLS连接保证通信的安全性（2-RTT）。
- HTTP协议会在TCP和TLS上通过一次往返发送请求并接收响应（1-RTT）。

### DHCP动态主机配置协议

- DHCP端口：主机生成DHCP报文，放入UDP用户数据报，其目的端口67、源端口68。
- 广播IP：该UDP用户数据报被放入IP分组，其广播IP目的地址(255.255.255.255)、源IP地址（0.0.0.0）。
- 广播MAC：该IP分组被放入MAC帧，与交换机连接的所有设备进行广播通信，其目的地址FF:FF:FF:FF:FF:FF。
- DCHP服务器响应：与交换机连接的DHCP服务器收到广播帧，不断地向上分解得到IP分组、UDP用户数据报、DHCP报文，之后生成DHCP ACK报文，该报文包含的信息：请求主机的IP地址、DNS服务器的IP地址、默认网关路由器的IP地址和子网掩码。
- 返回到请求主机：该报文依次放入UDP用户数据报、IP分组、MAC帧，该帧的目的地址是请求主机的MAC地址，交换机之前记录了MAC地址到其转发接口的交换表项，因此现在交换机可以直接知道向哪个接口发送该帧。
- 请求主机配置：主机收到该帧后，不断分解得到DHCP报文，进行配置它的IP地址、DNS服务器的IP地址、默认网关路由器的IP地址和子网掩码。

### DNS域名解析

- 主机生成包含网站域名的DNS报文，其传输层目的端口53。
- 该DNS报文放入IP分组，其目的地址为DNS服务器IP地址。
- 该IP分组放入MAC帧，其目的地址为网关路由器的MAC地址。
  - DHCP只知道网关路由器的IP地址，为了获取其MAC地址，需要使用ARP协议。
  - 主机生成ARP分组，其目的地址为网关路由器IP地址。
  - 该ARP分组放入MAC帧，其目的地址（FF:FF:FF:FF:FF:FF）。
  - 网关路由器接收到该帧后，不断向上分解得到ARP分组，发送ARP响应分组，其有网关路由器MAC地址。
- 网关路由器收到DNS报文的MAC帧，抽取出IP分组，根据转发表找到转发的路由器（内部网关协议（RIP、OSPF）和外部网关协议（BGP））。
- 到达DNS服务器后，解析DNS报文，在DNS数据库中查找域名，生成DNS报文，放入UDP用户数据报，放入IP分组。
- 通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

### 从输入网址到获得页面的过程

- DHCP动态配置本地主机IP：请求主机的IP地址、DNS服务器的IP地址、默认网关路由器的IP地址和子网掩码。
- DNS域名解析：网关路由器（其MAC地址通过ARP获取）、路由器、DNS服务器；浏览器自身的DNS缓存、操作系统的DNS缓存、本地的Host文件、本地DNS服务器、远程DNS服务器等。
- https连接：应用层https->传输层报文tcp三次握手->tls四次握手。
- 单个数据及页面：服务器接收到这个请求，并根据路径参数映射到特定的请求处理器进行处理，并将处理结果及相应的视图返回给浏览器。
- 浏览器单个渲染：浏览器解析并渲染视图，若遇到对js文件、css文件及图片等静态资源的引用，则重复上述步骤并向服务器请求这些资源。
- 浏览器完整渲染：浏览器根据其请求到的资源、数据渲染页面，最终向用户呈现一个完整的页面。
